#!/bin/bash

function usage() {
    echo
    echo "usage: $0 <db> <from host>"
    echo
    exit
}

if [ "$1" == "" ]; then
    usage
else
    DB="$1"
fi

if [ "$2" == "" ]; then
    HOST=localhost
else
    HOST="$2"
fi

echo "/* DB    = $DB */;"
echo "/* HOST  = $HOST */;"
echo

if [ "$MYSQL_USER" == "" ]; then
    MYSQL_USER=root
fi

if [ "$DB" == "mysql" ]; then
    mysql --user=$MYSQL_USER --password=$MYSQL_PASS --host=$HOST -N mysql -e "select concat(\"'\", user, \"'@'\", host, \"'\"), Password from user where not user like 'mysql.%'" | while read user pass ; do echo "GRANT USAGE ON *.* TO $user IDENTIFIED BY PASSWORD '$pass';" ; mysql --user=$MYSQL_USER --password=$MYSQL_PASS --host=$HOST -N -e "SHOW GRANTS FOR $user" | grep -v 'GRANT USAGE' | sed 's/\(\S\)$/\1;/' ; done
    echo "flush privileges;"
else
    if [ "$DB" == "?" ] || [ "$DB" == "*" ]; then
        echo "show databases;" | mysql --user=$MYSQL_USER --password=$MYSQL_PASS --host=$HOST
    else
        mysqldump --events --host=$HOST --user=$MYSQL_USER --password=$MYSQL_PASS --databases $DB --add-drop-database --create-options --extended-insert --flush-logs --flush-privileges --lock-tables 
    fi
fi

