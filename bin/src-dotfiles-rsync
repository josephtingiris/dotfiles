#!/bin/bash

dotfiles_rsync=$(which rsync 2> /dev/null)
if [ ! -x $dotfiles_srync ]; then
    echo "can't find executable rsync"
    exit 1
fi

dotfiles_to=""
if [ "$1" != "" ]; then
    if [[ $(echo "$1" | grep : 2> /dev/null) ]]; then
        dotfiles_to="${1}"
    else
        dotfiles_to="${1}:~"
    fi
fi
if [ "$dotfiles_to" == "" ]; then
    dotfiles_to="~"
fi

dotfiles_src="$(dirname $(readlink -e . 2> /dev/null | grep \/src\/dotfiles\/) 2> /dev/null)"
if [ "$dotfiles_src" == "" ]; then
    dotfiles_src="$(readlink -e . 2> /dev/null | grep \/src\/dotfiles)"
fi
if [ "$dotfiles_src" != "" ] && [ -d "$dotfiles_src" ]; then
    cd ${dotfiles_src}
    git pull || exit
    rsync_args="-avp"
    echo
    echo "rsync ${rsync_args} ${dotfiles_src}/ ${dotfiles_to}/"
    echo
    rsync ${rsync_args} ${dotfiles_src}/ ${dotfiles_to}/

    echo
    echo "rsync ${rsync_args} --delete-after ${dotfiles_src}/.git/ ${dotfiles_to}/.git/"
    echo
    rsync ${rsync_args} --delete-after ${dotfiles_src}/.git/ ${dotfiles_to}/.git/
else
    echo "this only works for/from src/dotfiles"
fi
