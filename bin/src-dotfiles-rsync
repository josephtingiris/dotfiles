#!/bin/bash

unset SSH_AUTH_SOCK

dotfiles_rsync=$(type -P rsync)
if [ ! -x ${dotfiles_rsync} ]; then
    echo "can't find executable rsync"
    exit 1
fi

HERE=$(pwd)

remote_host=false

dotfiles_to="${1}"
if [ "${dotfiles_to}" == "" ]; then
    echo
    echo "usage: $0 <host>"
    echo
    exit 1
else
    dotfiles_to_dir=""
    dotfiles_to_host=""
    if [[ "${dotfiles_to}" == *":"* ]]; then
        dotfiles_to_dir=${1##*:}
        dotfiles_to_host=${1%%:*}
    else
        if ping -c 1 "${1}" &> /dev/null; then
            remote_host=true
            dotfiles_to_host="${1}"
            dotfiles_to_dir="~"
        else
            if [ -d "${1}" ]; then
                dotfiles_to_host=${HOSTNAME}
                dotfiles_to_dir="${1}"
            else
                echo "${1} directory not found"
                exit 1
            fi
        fi
    fi
fi

if [ "${dotfiles_to_host}" == "" ] ;then
    dotfiles_to=${dotfiles_to_dir}
else
    if [ "${dotfiles_to_host}" == "${HOSTNAME}" ]; then
        remote_host=false
        dotfiles_to=${dotfiles_to_dir}
        if [ "${dotfiles_to_dir}" == "~" ]; then
            dotfiles_to="${HOME}"
        fi
    else
        if ping -c 1 "${dotfiles_to_host}" &> /dev/null; then
            remote_host=true
            dotfiles_to=${dotfiles_to_host}:${dotfiles_to_dir}
        else
            echo "${dotfiles_to_host} is dead"
            exit 1
        fi
    fi
fi

echo
echo "dotfiles_to_host  = ${dotfiles_to_host}"
echo "dotfiles_to_dir   = ${dotfiles_to_dir}"
echo "dotfiles_to       = ${dotfiles_to}"
echo

home_src_dotfiles="${HOME}/src/dotfiles"

if ! ${remote_host}; then
    if [ "${HERE}" != "${home_src_dotfiles}" ]; then
        if ! git status | grep nothing\ to\ commit 2> /dev/null; then
            git status

            echo
            echo "take care of that and try again"
            echo

            exit
        fi
    fi
fi

if [ "${home_src_dotfiles}" != "" ] && [ -d "${home_src_dotfiles}" ]; then
    echo
    echo "${HOME}/src/dotfiles directory found"
    echo

    cd "${HOME}/src/dotfiles"

    git pull || exit

    rsync_args="-avp"

    echo
    echo "rsync ${rsync_args} ${home_src_dotfiles}/ ${dotfiles_to}/"
    echo
    ${dotfiles_rsync} ${rsync_args} ${home_src_dotfiles}/ ${dotfiles_to}/

    echo
    echo "rsync ${rsync_args} --delete-after ${home_src_dotfiles}/.git/ ${dotfiles_to}/.git/"
    echo
    ${dotfiles_rsync} ${rsync_args} --delete-after ${home_src_dotfiles}/.git/ ${dotfiles_to}/.git/

else
    echo "${HOME}/src/dotfiles directory not found"
fi

cd "${HERE}"

exit
