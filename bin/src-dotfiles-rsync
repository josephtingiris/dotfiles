#!/bin/bash

# 20201012, joseph.tingiris@gmail.com

function usage() {
    echo
    echo "usage: $0 [user@]<host|directory>[:<directory>] [noping]"
    echo
    exit 1
}

NOPING=0

if [ "$2" == "noping" ]; then
    NOPING=1
fi

dotfiles_src="${HOME}/src/dotfiles"
if [ ! -d "${dotfiles_src}" ]; then
    echo "${dotfiles_src} directory not found"
fi

rsync=$(type -P rsync)
if [ ! -x ${rsync} ]; then
    echo "can't find executable rsync"
    exit 1
fi

HERE=$(pwd)

dotfiles_to_input="${1}"
if [ "${dotfiles_to_input}" == "" ]; then
    usage
fi

dotfiles_to_dir=""
dotfiles_to_host=""
dotfiles_to_remote=false
dotfiles_to_user=""

if [[ "${dotfiles_to_input}" == *"@"* ]]; then
    dotfiles_to_user=${1%%@*}
    dotfiles_to_host=${1##*@}
fi

if [[ "${dotfiles_to_input}" == *":"* ]]; then
    dotfiles_to_dir=${1##*:}
    dotfiles_to_host=${1%%:*}
fi

if [[ "${dotfiles_to_host}" == *"@"* ]]; then
    dotfiles_to_user=${dotfiles_to_host%%@*}
    dotfiles_to_host=${dotfiles_to_host##*@}
fi

if [ "${dotfiles_to_host}" == "" ] && [ "${dotfiles_to_user}" == "" ] && [ "${dotfiles_to_dir}" == "" ]; then
    dotfiles_to_host="${dotfiles_to_input}"
fi

if [ "${dotfiles_to_user}" == "" ]; then
    dotfiles_to_user=$(logname)
fi

if [ -d "${dotfiles_to_input}" ]; then
    dotfiles_to_dir="${dotfiles_to_input}"
    dotfiles_to_host=""
else
    if [ "${dotfiles_to_dir}" == "" ]; then
        dotfiles_to_dir="~"
    fi
    dotfiles_to_remote=true
fi

if [ ${NOPING} -eq 0 ]; then
    if ${dotfiles_to_remote}; then
        if ping -c 1 "${dotfiles_to_host}" &> /dev/null; then
            dotfiles_to_remote=true
        else
            echo "${dotfiles_to_host} ping failed"
            exit 1
        fi
    fi
fi

ssh_copy_id=""
dotfiles_to=""

if [ ${#dotfiles_to_user} -gt 0 ] && ${dotfiles_to_remote}; then
    ssh_copy_id+="${dotfiles_to_user}@"
    dotfiles_to+="${dotfiles_to_user}@"
fi

if [ ${#dotfiles_to_host} -gt 0 ] && ${dotfiles_to_remote}; then
    ssh_copy_id+="${dotfiles_to_host}"
    dotfiles_to+="${dotfiles_to_host}:"
fi

dotfiles_to+="${dotfiles_to_dir}"

echo
echo "dotfiles_to_input  = ${dotfiles_to_input}"
echo "dotfiles_to_user   = ${dotfiles_to_user}"
[ ${dotfiles_to_host} ] && echo "dotfiles_to_host   = ${dotfiles_to_host}"
echo "dotfiles_to_dir    = ${dotfiles_to_dir}"
${dotfiles_to_remote} && echo "dotfiles_to_remote = ${dotfiles_to_remote}"
echo "dotfiles_to        = ${dotfiles_to}"
[ ${ssh_copy_id} ] && echo "ssh_copy_id        = ${ssh_copy_id}"
echo

echo
echo "${dotfiles_src} directory found, pulling ..."
echo

cd "${dotfiles_src}"
git pull || exit
echo


if ${dotfiles_to_remote}; then
    ssh ${ssh_copy_id} ls &> /dev/null
    if [ $? -ne 0 ]; then
        unset SSH_AUTH_SOCK
    fi
fi

rsync_args="-avp"

echo
echo "rsync ${rsync_args} ${dotfiles_src}/ ${dotfiles_to}/"
echo
${rsync} ${rsync_args} ${dotfiles_src}/ ${dotfiles_to}/ || exit

echo
echo "rsync ${rsync_args} --delete-after ${dotfiles_src}/.git/ ${dotfiles_to}/.git/"
echo
${rsync} ${rsync_args} --delete-after ${dotfiles_src}/.git/ ${dotfiles_to}/.git/ || exit
